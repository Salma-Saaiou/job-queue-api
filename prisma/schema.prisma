generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    // url      = env("DATABASE_URL")
}

model User {
    id            String         @id @default(uuid())
    email         String         @unique
    password      String
    name          String?
    role          UserRole       @default(USER)
    createdAt     DateTime       @default(now())
    updatedAt     DateTime       @updatedAt
    deletedAt     DateTime?
    refreshTokens RefreshToken[]
    jobs          Job[]

    @@map("users")
}

enum UserRole {
    USER
    ADMIN
}

model RefreshToken {
    id        String   @id @default(uuid())
    userId    String
    token     String   @unique
    createdAt DateTime @default(now())
    expiresAt DateTime
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@map("refresh_tokens")
}

enum JobStatus {
    PENDING
    PROCESSING
    COMPLETED
    FAILED
    DEAD
    CANCELLED
}

model Job {
    id       String    @id @default(uuid())
    type     String
    payload  Json
    status   JobStatus @default(PENDING)
    priority Int       @default(0)
    workerId String?

    scheduledFor DateTime?
    startedAt    DateTime?
    completedAt  DateTime?

    attempts    Int @default(0)
    maxAttempts Int @default(3)

    result Json?
    error  String?

    createdBy String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user        User         @relation(fields: [createdBy], references: [id], onDelete: Cascade)
    jobAttempts JobAttempt[]

    @@index([status])
    @@index([priority])
    @@index([workerId])
    @@map("jobs")
}

model JobAttempt {
    id            String    @id @default(uuid())
    job           Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
    jobId         String
    attemptNumber Int
    startedAt     DateTime  @default(now())
    finishedAt    DateTime?
    error         String?

    @@index([jobId])
    @@map("job_attempts")
}
